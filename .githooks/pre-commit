#!/usr/bin/env bash
set -euo pipefail

echo "==> pre-commit: running checks..."

echo "--- cargo fmt --check"
cargo fmt --check

echo "--- cargo clippy"
cargo clippy --workspace --all-targets -- -D warnings

echo "--- cargo test"
cargo test --workspace

echo "--- cargo doc (warnings = errors)"
RUSTDOCFLAGS="-D warnings" cargo doc --workspace --no-deps

if command -v cargo-deny &>/dev/null; then
    echo "--- cargo deny check"
    cargo deny check
else
    echo "--- cargo deny: skipped (not installed, run 'make setup')"
fi

echo "--- README.md freshness check"
./scripts/generate-readme.sh
git diff --quiet README.md || {
    echo "error: README.md is out of date."
    echo "Run 'make readme' and stage the result before committing."
    exit 1
}

echo "--- ww-lsp freshness check"
INSTALLED_LSP="$HOME/.cargo/bin/ww-lsp"
if [[ -f "$INSTALLED_LSP" ]]; then
    # Check if any ww-lsp or ww-dsl source is newer than installed binary
    NEWEST_SRC=$(find crates/ww-lsp crates/ww-dsl crates/ww-core -name '*.rs' -newer "$INSTALLED_LSP" 2>/dev/null | head -1)
    if [[ -n "$NEWEST_SRC" ]]; then
        echo "warning: ww-lsp in ~/.cargo/bin is outdated."
        echo "Run 'make install-lsp' to update the VS Code extension."
    fi
else
    echo "warning: ww-lsp not installed. Run 'make setup' or 'make install-lsp'."
fi

echo "==> pre-commit: all checks passed."
